(()=>{"use strict";var e={7689:function(e,t,s){var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(n,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}c((i=i.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=s(7558),a=s(5034),r=s(8404),c=n(s(9050));class d{constructor(){this.client=o.createClient(a.redisTokenOptions)}static init(){return d.instance||(c.default.warn("Configurando cliente de redis"),d.instance=new d),c.default.info("Iniciando cliente de redis"),d.instance}Connect(e){this.client.on("connect",e?e():()=>c.default.debug("Servidor conectado como cliente a la red de redis")),this.client.on("error",(e=>{c.default.error(`Algo salió mal -> ${e}`),c.default.debug("Revisa las variables de configuración para el cliente de redis")}))}addForgotTokenToList(e,t){t&&e&&(this.client.select(1),this.client.set(e.toString(),t.toString()),this.client.expire(e.toString(),r.EXP_FORGOT_TOKEN))}updateForgotTokenToList(e,t){e&&t&&(this.client.select(1),this.client.hset(e.toString(),"forgotToken",t))}removeForgotTokenFromList(e){e&&(this.client.select(1),this.client.del(e.toString()))}getForgotTokenFromList(e){return this.client.select(1),new Promise(((t,s)=>{this.client.get(e.toString(),((e,i)=>{e&&s(e),t(i)}))}))}existForgotToken(e){return this.client.select(1),new Promise(((t,s)=>{this.client.exists(e.toString(),((e,i)=>e?s(e):t(0!==i)))}))}saveDataInCache(e,t,s){this.client.select(4),this.client.hset(e,t,s),this.client.expire(e,r.TIME_EXPIRE_DATA_CACHE)}removeDataInCache(e){this.client.select(4),this.client.del(e)}updateDataInCache(e,t){this.client.select(4),this.client.set(e,t)}getDataInCache(e,t){return new Promise(((s,i)=>{this.client.select(4),this.client.hget(e,t,((e,t)=>e?i(e):s(t)))}))}saveCodeConfirm(e,t){this.client.select(5),this.client.set(e.toString(),t),this.client.expire(e.toString(),300)}removeCodeConfirm(e){this.client.select(5),this.client.del(e.toString())}getCodeConfirm(e){return new Promise(((t,s)=>{this.client.select(5),this.client.get(e.toString(),((e,n)=>i(this,void 0,void 0,(function*(){return e?s(e):t(n)}))))}))}get Client(){return this.client}}t.default=d},1244:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(298),o=i(s(7689)),a=s(2779);class r{constructor(){this.redis=o.default.init(),this.rateLimiterLogin=new n.RateLimiterRedis(Object.assign(Object.assign({},a.configLimiterLogin),{storeClient:this.redis.Client})),this.rateLimiterAPI=new n.RateLimiterRedis(Object.assign(Object.assign({},a.configLimiterAPI),{storeClient:this.redis.Client}))}static init(){return r.instance||(r.instance=new r),r.instance}get limiterLogin(){return this.redis.Client.select(2),this.rateLimiterLogin}get limiterAPI(){return this.redis.Client.select(3),this.rateLimiterAPI}get loginAllData(){return this.redis.Client.select(2),new Promise(((e,t)=>this.redis.Client.KEYS("*",((s,i)=>s?t(s):e(i)))))}}t.default=r},1890:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});const s=["https://app1.localhost","https://localhost","https://www.localhost","https://www.breinertech.me","https://breinertech.me","https://ierec.net","https://www.ierec.net"];t.default=()=>(e,t)=>{-1===s.indexOf(e)&&e?new Error(`Acceso a ${e} no permitido por el CORS`):t(null,!0)}},1888:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Roles=t.config=t.URL=void 0;const i=s(8404);t.URL=()=>{let e="";return e="production"===i.NODE_ENV?`mongodb+srv://${i.DB_USER}:${i.DB_PASSWORD}@${i.DB_HOST}/${i.DB_NAME}`:`mongodb://${i.DB_HOST}:${i.DB_PORT}/${i.DB_NAME}`,e},t.config={autoIndex:!1,maxPoolSize:10,serverSelectionTimeoutMS:5e3,socketTimeoutMS:45e3},t.Roles=["admin","user","maestro"]},6847:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.transportConfig=void 0;const i=s(8404);t.transportConfig={host:i.HOST_EMAIL,port:i.SERVICE_EMAIL_PORT,secure:!0,service:i.SERVICE_EMAIL,auth:{user:i.USER_EMAIL,pass:i.PASSWORD_EMAIL}}},1778:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.OptionsForgotToken=t.OptionsRefreshToken=t.OptionsAccessToken=void 0;const i=s(8404);t.OptionsAccessToken={expiresIn:i.EXP_ACCESS_TOKEN,algorithm:"HS256"},t.OptionsRefreshToken={expiresIn:i.EXP_REFRESH_TOKEN,algorithm:"HS256"},t.OptionsForgotToken={expiresIn:i.EXP_FORGOT_TOKEN,algorithm:"HS256"}},2779:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.configLimiterAPI=t.configLimiterLogin=void 0;const i=s(8404);t.configLimiterLogin={storeClient:null,keyPrefix:i.KEY_REDIS_LOGIN_ACCESS,points:i.LIMIT_LOGIN_TRIES,duration:i.LIMIT_LOGIN_BEFORE_NEXT_LOCK,blockDuration:i.LIMIT_LOGIN_DURATION_LOCK},t.configLimiterAPI={storeClient:null,keyPrefix:i.KEY_REDIS_API_ACCESS,points:i.LIMIT_API_TRIES,duration:i.LIMIT_API_BEFORE_NEXT_LOCK,blockDuration:i.LIMIT_API_DURATION_LOCK}},9050:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(7773),o=s(1017),a=s(7147),{colorize:r,combine:c,printf:d}=n.format,l=i(s(9013)),u=o.resolve(__dirname,"../logs");a.existsSync(u)||a.mkdirSync(u),t.default=n.createLogger({level:"debug",transports:[new n.transports.Console({format:c(r({level:!0}),d((({level:e,message:t})=>`[${e}]: ${t} -- ${l.default(new Date).format("dddd, DD/MM/YYYY, HH:mm:ss")}`)))}),new n.transports.File({filename:`${u}/debugger.log`,format:d((({level:e,message:t})=>`[${e}]: ${t} -- ${l.default(new Date).format("dddd, DD/MM/YYYY, HH:mm:ss")}`))})]})},9013:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(s(2245));n.default.locale("es"),t.default=n.default},5034:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.redisTokenOptions=void 0;const i=s(8404);t.redisTokenOptions={port:i.RD_PORT,host:i.RD_HOST,password:i.RD_PASSWORD,enable_offline_queue:!0}},1580:function(e,t,s){var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(n,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}c((i=i.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=s(1185),a=s(1888),r=n(s(9050));class c{constructor(){this.url=a.URL()}static init(){return c.instance||(c.instance=new c,r.default.debug("Configurando servicio de base de datos")),c.instance}Connect(e){return i(this,void 0,void 0,(function*(){try{return yield o.connect(this.url,a.config),e&&e(),1}catch(e){return r.default.error("La conexión a la base de datos ha fallado - motivo: ",e),0}}))}Disconnect(e){return i(this,void 0,void 0,(function*(){return o.disconnect().then((t=>(e&&e(),1))).catch((e=>(r.default.error("Desconexión de la base de datos ha fallado - motivo, ",e),0)))}))}}t.default=c},5163:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(1185);i(s(9050)).default.info("configurando esquema países -> base de datos");const o=new n.Schema({name:{type:String,required:!0},dial_code:{type:String,required:!0},country_code:{type:String,required:!0}});t.default=o},1324:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(1185),o=i(s(8037)),a=s(8404);i(s(9050)).default.info("configurando modelos de sesiones -> base de datos");const r=new n.Schema({user:{type:n.Schema.Types.ObjectId,ref:"Users"},refreshToken:{type:String,required:!0},accessToken:{type:String,required:!0},ip:{type:String,required:!0},sessionExpire:{type:Date,default:Date.now,expires:a.EXP_REFRESH_TOKEN}},{collection:"sessions"});r.plugin(o.default),r.index({sessionExpire:1},{expireAfterSeconds:a.EXP_REFRESH_TOKEN});const c=n.model("Sessions",r);t.default=c},5042:function(e,t,s){var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(n,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}c((i=i.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=s(1185),a=n(s(8037)),r=s(8432),c=s(1888),d=s(9075),l=n(s(9050)),u=n(s(5163));l.default.info("configurando modelo de usuarios -> base de datos");const h=new o.Schema({name:{type:String,required:!0},lastname:{type:String,default:""},username:{type:String,default:"",unique:!0},password:{type:String,required:!0},email:{type:String,required:!0,unique:!0,uniqueCaseInsensitive:!0},profesional_info:{type:String,required:!1},country:u.default,emailConfirm:{type:Boolean,required:!1,default:!1},greetingWelcome:{type:Boolean,required:!1,default:!0},roles:{type:[String],required:!1,default:"user",enum:{values:c.Roles,message:"{VALUE} no es un rol válido!"}},img:{type:String,required:!1},portada:{type:String,required:!1},state:{type:Boolean,default:!0},google:{type:Boolean,default:!1},facebook:{type:Boolean,default:!1},phone:{type:String},created_at:{type:Date,default:Date.now}},{collection:"users"});h.methods.toJSON=function(){const e=this.toObject();return delete e.password,delete e.__v,delete e.createdAt,delete e.updatedAt,e},h.pre("updateOne",(function(e){const t=this._update;return t.password?(t.password=d.bcryptPassword(t.password,t._id),e()):e()})),h.pre("save",(function(e){const t=this;return t.password=d.bcryptPassword(t.password,t._id),e()})),h.method("compareHash",(function(e,t){const s=this;return new Promise(((t,i)=>{r.compare(e,s.password,((e,s)=>{e&&i(e),t(s)}))}))})),h.path("email").validate((e=>i(void 0,void 0,void 0,(function*(){return!(yield o.models.Users.countDocuments({email:e}))}))),"El correo electrónico ya esta registrado!"),h.plugin(a.default);const m=o.model("Users",h);t.default=m},8014:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(5184),o=s(6847),a=i(s(8149)),r=i(s(9050));class c{constructor(){this.transporterConfig=o.transportConfig}static init(){return r.default.warn("Configurando nuevo servicio de correos"),new c}get Transporter(){return this.transport||(r.default.warn("iniciando configuración de transporte de email"),this.transport=n.createTransport(a.default(this.transporterConfig))),this.transport}sendMail(e){return new Promise(((t,s)=>this.Transporter.sendMail(e,(e=>{if(e)return s(e);t(!0)}))))}}t.default=c},9075:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.bcryptPassword=void 0;const n=s(8432),o=i(s(9050));t.bcryptPassword=(e,t)=>{o.default.info(`Encriptando contraseña del usuario ${t}`);const s=n.genSaltSync(10);return n.hashSync(e,s)}},7210:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.serverCert=t.serverKey=void 0;const n=i(s(1017)),o=i(s(7147));i(s(9050)).default.info("Agregando certificados SSL"),t.serverKey=o.default.readFileSync(n.default.resolve(__dirname,"..","cert","key.pem")),t.serverCert=o.default.readFileSync(n.default.resolve(__dirname,"..","cert","cert.pem"))},8404:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FACEBOOK_CLIENT_SECRET=t.FACEBOOK_CLIENT_ID=t.GOOGLE_CLIENT_SECRET=t.GOOGLE_CLIENT_ID=t.TIME_EXPIRE_DATA_CACHE=t.LIMIT_API_DURATION_LOCK=t.LIMIT_API_BEFORE_NEXT_LOCK=t.LIMIT_API_TRIES=t.KEY_REDIS_API_ACCESS=t.LIMIT_LOGIN_DURATION_LOCK=t.LIMIT_LOGIN_BEFORE_NEXT_LOCK=t.LIMIT_LOGIN_TRIES=t.KEY_REDIS_LOGIN_ACCESS=t.PASSWORD_EMAIL=t.USER_EMAIL=t.SERVICE_EMAIL_PORT=t.SERVICE_EMAIL=t.HOST_EMAIL=t.EXP_FORGOT_TOKEN=t.EXP_REFRESH_TOKEN=t.EXP_ACCESS_TOKEN=t.SEED_FORGOT_PASSWORD_TOKEN=t.SEED_REFRESH_TOKEN=t.SEED_ACCESS_TOKEN=t.RD_PASSWORD=t.RD_HOST=t.RD_PORT=t.DB_HOST=t.DB_PORT=t.DB_PASSWORD=t.DB_USER=t.DB_NAME=t.PORT=t.APP_NAME=t.TZ=t.NODE_ENV=void 0,i(s(9050)).default.warn("Configurando variables de entorno"),t.NODE_ENV="production",t.TZ=String("America/Guayaquil"),t.APP_NAME=String("USERS_AUTH"),t.PORT=Number("443"),t.DB_NAME=String("authDB"),t.DB_USER=String("adminUsb"),t.DB_PASSWORD=String("n01chqo4HhjS5GqO"),t.DB_PORT=Number(""),t.DB_HOST=String("cluster0.cbr4m.mongodb.net"),t.RD_PORT=Number("6379"),t.RD_HOST=String("redis-svc"),t.RD_PASSWORD=String("pass123456"),t.SEED_ACCESS_TOKEN=String("acessTokenseedPass"),t.SEED_REFRESH_TOKEN=String("refreshTokenseedPass"),t.SEED_FORGOT_PASSWORD_TOKEN=String("forgotTokenseedPass"),t.EXP_ACCESS_TOKEN=Number("900"),t.EXP_REFRESH_TOKEN=Number("7776000"),t.EXP_FORGOT_TOKEN=Number("600"),t.HOST_EMAIL=String("smtp.gmail.com"),t.SERVICE_EMAIL=String("gmail"),t.SERVICE_EMAIL_PORT=Number("465"),t.USER_EMAIL=String("aulavinculacion@gmail.com"),t.PASSWORD_EMAIL=String("g6ljWQKf4205Vz"),t.KEY_REDIS_LOGIN_ACCESS=String("login"),t.LIMIT_LOGIN_TRIES=Number("5"),t.LIMIT_LOGIN_BEFORE_NEXT_LOCK=Number("0"),t.LIMIT_LOGIN_DURATION_LOCK=Number("60"),t.KEY_REDIS_API_ACCESS=String("apiaccess"),t.LIMIT_API_TRIES=Number("30"),t.LIMIT_API_BEFORE_NEXT_LOCK=Number("2"),t.LIMIT_API_DURATION_LOCK=Number("5"),t.TIME_EXPIRE_DATA_CACHE=Number("18000"),t.GOOGLE_CLIENT_ID=String("221175379713-024fp6e1jmako7g99ca4bi1ae7kc78p9.apps.googleusercontent.com"),t.GOOGLE_CLIENT_SECRET=String({SHELL:"/bin/fish",SESSION_MANAGER:"local/tuf:@/tmp/.ICE-unix/1506,unix/tuf:/tmp/.ICE-unix/1506",npm_package_devDependencies__types_express_validator:"^3.0.0",COLORTERM:"truecolor",XDG_CONFIG_DIRS:"/home/gt37285/.config/kdedefaults:/etc/xdg",npm_package_main:"index.js",npm_package_repository_url:"https://github.com/TesisProyect/tesis-users-backend",TERM_PROGRAM_VERSION:"1.64.0",npm_package_scripts_audit:"better-npm-audit audit audit",APPLICATION_INSIGHTS_NO_DIAGNOSTIC_CHANNEL:"true",npm_package_devDependencies__types_nodemailer:"^6.4.2",NODE:"/usr/bin/node",npm_config_ignore_scripts:"",npm_package_devDependencies__types_moment:"^2.13.0",npm_package_dependencies_moment:"^2.29.1",LC_ADDRESS:"es_EC.UTF-8",LC_NAME:"es_EC.UTF-8",BREAKPAD_DUMP_LOCATION:"/home/gt37285/.config/Code - OSS/exthost Crash Reports",npm_package_devDependencies_better_npm_audit:"^2.1.0",npm_config_argv:'{"remain":[],"cooked":["run","build"],"original":["build"]}',npm_config_bin_links:"true",DESKTOP_SESSION:"plasma",LC_MONETARY:"es_EC.UTF-8",npm_package_devDependencies__types_express:"^4.17.12",GTK_RC_FILES:"/etc/gtk/gtkrc:/home/gt37285/.gtkrc:/home/gt37285/.config/gtkrc",NO_AT_BRIDGE:"1",npm_package_dependencies_google_auth_library:"^7.4.1",XCURSOR_SIZE:"24",npm_package_devDependencies_nodemon:"^2.0.9",EDITOR:"nano",npm_package_devDependencies__types_helmet:"^4.0.0",GTK_MODULES:"canberra-gtk-module",XDG_SEAT:"seat0",npm_package_dependencies_axios:"^0.21.1",PWD:"/mnt/data/code/proyectos/tesis/backend/auth",npm_package_dependencies_morgan:"^1.10.0",npm_config_save_prefix:"^",XDG_SESSION_DESKTOP:"plasma",LOGNAME:"gt37285",QT_QPA_PLATFORMTHEME:"qt5ct",XDG_SESSION_TYPE:"x11",npm_package_dependencies_cors:"^2.8.5",npm_package_dependencies_express_fileupload:"^1.2.1",npm_package_devDependencies__typescript_eslint_parser:"^5.3.0",SYSTEMD_EXEC_PID:"1299",npm_package_scripts_build:"rm -rf ./dist && webpack --config webpack/webpack.config --env env=prod",_:"/mnt/data/code/proyectos/tesis/backend/auth/node_modules/.bin/webpack",OMF_PATH:"/home/gt37285/.local/share/omf",XAUTHORITY:"/run/user/1000/gdm/Xauthority",npm_package_devDependencies_prettier:"^2.4.1",VSCODE_GIT_ASKPASS_NODE:"/usr/lib/electron13/electron",npm_package_devDependencies_eslint_config_prettier:"^8.3.0",npm_package_dependencies_mongoose:"^6.0.13",npm_package_devDependencies__types_mongoose:"^5.11.97",WINDOWPATH:"2",MOTD_SHOWN:"pam",GDM_LANG:"es_EC.UTF-8",npm_package_devDependencies_nodemon_webpack_plugin:"^4.5.2",GTK2_RC_FILES:"/etc/gtk-2.0/gtkrc:/home/gt37285/.gtkrc-2.0:/home/gt37285/.config/gtkrc-2.0",HOME:"/home/gt37285",USERNAME:"gt37285",npm_config_version_git_tag:"true",LC_PAPER:"es_EC.UTF-8",LANG:"es_EC.UTF-8",npm_package_devDependencies__types_morgan:"^1.9.2",npm_package_devDependencies_webpack:"^5.62.1",npm_package_devDependencies__types_mongoose_paginate_v2:"^1.4.0",XDG_CURRENT_DESKTOP:"KDE",npm_config_init_license:"MIT",npm_package_version:"1.0.0",npm_package_devDependencies__types_cors:"^2.8.11",npm_package_devDependencies__typescript_eslint_eslint_plugin:"^5.3.0",npm_package_devDependencies__types_bcryptjs:"^2.4.2",npm_config_version_commit_hooks:"true",npm_package_repository_type:"git",GIT_ASKPASS:"/usr/lib/code/extensions/git/dist/askpass.sh",npm_package_dependencies_express:"^4.17.1",npm_package_dependencies_jsonwebtoken:"^8.5.1",npm_package_devDependencies_retire:"^3.0.0",npm_package_dependencies_rate_limiter_flexible:"^2.2.2",INIT_CWD:"/mnt/data/code/proyectos/tesis/backend/auth",CHROME_DESKTOP:"code-oss.desktop",npm_package_scripts_format:"prettier --write ./src",KDE_SESSION_UID:"1000",npm_package_devDependencies__types_supertest:"^2.0.11",npm_lifecycle_script:"rm -rf ./dist && webpack --config webpack/webpack.config --env env=prod",npm_package_description:"system version's users for project of tesis",VSCODE_GIT_ASKPASS_EXTRA_ARGS:"",npm_config_version_tag_prefix:"v",YARN_WRAP_OUTPUT:"false",npm_package_dependencies_nodemailer:"^6.6.2",npm_package_devDependencies__types_module_alias:"^2.0.0",npm_package_devDependencies_ts_loader:"^9.2.6",XDG_SESSION_CLASS:"user",TERM:"xterm-256color",LC_IDENTIFICATION:"es_EC.UTF-8",npm_package_dependencies_express_validator:"^6.12.0",npm_package_name:"users",npm_package_devDependencies_tsconfig_paths:"^3.9.0",npm_package_devDependencies__types_express_fileupload:"^1.1.7",USER:"gt37285",npm_package_devDependencies_webpack_merge:"^5.8.0",npm_package_devDependencies__types_jest:"^26.0.24",npm_package_devDependencies_webpack_cli:"^4.9.1",npm_package_devDependencies__types_redis:"^2.8.30",VSCODE_GIT_IPC_HANDLE:"/run/user/1000/vscode-git-9b4c0e3af9.sock",npm_package_dependencies_nodemailer_smtp_transport:"^2.7.4",npm_package_dependencies_redis:"^3.1.2",KDE_SESSION_VERSION:"5",npm_package_author_email:"jbpaig@gmail.com",npm_package_dependencies_dotenv:"^10.0.0",DISPLAY:":0",npm_lifecycle_event:"build",SHLVL:"1",npm_config_version_git_sign:"",npm_config_version_git_message:"v%s",npm_package_devDependencies_eslint_webpack_plugin:"^3.1.0",npm_package_devDependencies_eslint:"^8.1.0",LC_TELEPHONE:"es_EC.UTF-8",npm_package_dependencies_node_mocks_http:"^1.10.1",LC_MEASUREMENT:"es_EC.UTF-8",XDG_VTNR:"2",npm_package_devDependencies__types_jsonwebtoken:"^8.5.4",XDG_SESSION_ID:"3",npm_config_user_agent:"yarn/1.22.17 npm/? node/v17.3.0 linux x64",npm_package_scripts_lint:"eslint --fix .",npm_execpath:"/usr/lib/node_modules/yarn/bin/yarn.js",npm_package_dependencies_winston:"^3.3.3",npm_package_devDependencies_supertest:"^6.1.3",npm_package_scripts_test:"jest --watch --detectOpenHandles",XDG_RUNTIME_DIR:"/run/user/1000",npm_config_strict_ssl:"true",npm_package_dependencies_helmet:"^4.6.0",npm_package_devDependencies_module_alias:"^2.2.2",LC_TIME:"es_EC.UTF-8",npm_package_scripts_dev:"webpack --config webpack/webpack.config --env env=dev",npm_package_dependencies_typescript:"^4.3.4",VSCODE_GIT_ASKPASS_MAIN:"/usr/lib/code/extensions/git/dist/askpass-main.js",QT_AUTO_SCREEN_SCALE_FACTOR:"0",XCURSOR_THEME:"capitaine-light",KDE_FULL_SESSION:"true",GDK_BACKEND:"x11",npm_package_devDependencies_webpack_node_externals:"^3.0.0",npm_package_scripts_start:"node ./dist/bundle.js",BROWSER:"firefox",PATH:"/tmp/yarn--1644428941476-0.2834271002610629:/mnt/data/code/proyectos/tesis/backend/auth/node_modules/.bin:/home/gt37285/.config/yarn/link/node_modules/.bin:/home/gt37285/.yarn/bin:/usr/libexec/lib/node_modules/npm/bin/node-gyp-bin:/usr/lib/node_modules/npm/bin/node-gyp-bin:/usr/bin/node_modules/npm/bin/node-gyp-bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/bin/site_perl:/usr/bin/vendor_perl:/usr/bin/core_perl:/mnt/data/code/go/bin",npm_package_dependencies_bcryptjs:"^2.4.3",GDMSESSION:"plasma",npm_package_dependencies_mongoose_paginate_v2:"^1.4.2",npm_package_author_name:"breiner",ORIGINAL_XDG_CURRENT_DESKTOP:"KDE",DBUS_SESSION_BUS_ADDRESS:"unix:path=/run/user/1000/bus",npm_package_license:"ISC",KDE_APPLICATIONS_AS_SCOPE:"1",MAIL:"/var/spool/mail/gt37285",npm_config_registry:"https://registry.yarnpkg.com",npm_config_ignore_optional:"",OMF_CONFIG:"/home/gt37285/.config/omf",npm_node_execpath:"/usr/bin/node",LC_NUMERIC:"es_EC.UTF-8",GOPATH:"/mnt/data/code/go",npm_package_devDependencies_jest:"^27.0.6",TERM_PROGRAM:"vscode",npm_config_init_version:"1.0.0",PORT:"443",APPNAME:"USERS_AUTH",TZ:"America/Guayaquil",DB_NAME:"authDB",DB_USER:"adminUsb",DB_PASSWORD:"n01chqo4HhjS5GqO",DB_PORT:"",DB_HOST:"cluster0.cbr4m.mongodb.net",RD_PORT:"6379",RD_HOST:"redis-svc",RD_PASSWORD:"pass123456",KEY_REDIS_LOGIN_ACCESS:"login",LIMIT_LOGIN_TRIES:"5",LIMIT_LOGIN_BEFORE_NEXT_LOCK:"0",LIMIT_LOGIN_DURATION_LOCK:"60",KEY_REDIS_API_ACCESS:"apiaccess",LIMIT_API_TRIES:"30",LIMIT_API_BEFORE_NEXT_LOCK:"2",LIMIT_API_DURATION_LOCK:"5",TIME_EXPIRE_DATA_CACHE:"18000",SEED_ACCESS_TOKEN:"acessTokenseedPass",SEED_REFRESH_TOKEN:"refreshTokenseedPass",SEED_FORGOT_PASSWORD_TOKEN:"forgotTokenseedPass",EXP_ACCESS_TOKEN:"900",EXP_REFRESH_TOKEN:"7776000",EXP_FORGOT_TOKEN:"600",HOST_EMAIL:"smtp.gmail.com",SERVICE_EMAIL:"gmail",SERVICE_EMAIL_PORT:"465",USER_EMAIL:"aulavinculacion@gmail.com",PASSWORD_EMAIL:"g6ljWQKf4205Vz",GOOGLE_CLIENT_ID:"221175379713-024fp6e1jmako7g99ca4bi1ae7kc78p9.apps.googleusercontent.com",FACEBOOK_CLIENT_ID:"206687408331711",FACEBOOK_CLIENT_SECRET:"481bac16d895370af7493ca386b9accb"}.GOOGLE_CLIENT_SECRET),t.FACEBOOK_CLIENT_ID=String("206687408331711"),t.FACEBOOK_CLIENT_SECRET=String("481bac16d895370af7493ca386b9accb")},4405:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.fetch=void 0;const n=i(s(2167));t.fetch=e=>(e.method||(e.method="get"),e.headers||(e.headers={}),n.default(e))},2260:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=(e,t,s)=>(e.status||(e.status=500),s.status(e.status).json(e))},9588:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getIP=void 0,t.getIP=e=>new Promise((t=>{let s;s=e.headers["x-forwarded-for"]?e.headers["x-forwarded-for"]:e.socket&&e.socket.remoteAddress?e.socket.remoteAddress:e.ip,t(String(s))}))},3142:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.generateJWT=void 0;const n=s(9344),o=s(8404),a=s(1778),r=i(s(9050));t.generateJWT=(e,t)=>{let s;switch(e){case"access":s=n.sign(t,o.SEED_ACCESS_TOKEN,a.OptionsAccessToken);break;case"refresh":s=n.sign(t,o.SEED_REFRESH_TOKEN,a.OptionsRefreshToken);break;case"forgot-password":s=n.sign(t,o.SEED_FORGOT_PASSWORD_TOKEN,a.OptionsForgotToken);break;default:throw r.default.error(`Tipo de token no valido generado por ${t.uid}`),new Error("Token's type isn't valid")}return r.default.info(`Generando token de ${e} para usuario ${t.uid}`),s}},7093:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(9470),o=i(s(9050)),a=s(1017),r=s(7147),c=i(s(9013));class d{constructor(){this.dateNow=c.default(new Date),this.init()}static init(){return d.instace||(o.default.warn("Configurando nueva instancia de librería morgan"),this.instace=new d),o.default.info("Iniciando configuración de librería morgan"),this.instace}init(){let e="../logs";r.existsSync(e)||r.mkdirSync(e),this.tokens(),this.formats()}tokens(){n.token("date",(()=>this.dateNow.format("dddd, DD/MM/YYYY, HH:mm:ss "))),n.token("uid",((e,t)=>{const s=e.decoded;return(null==s?void 0:s.uid)?s.uid.toString():""}))}formats(){return o.default.info("configurando formato"),n.format("personalizado",':remote-addr :uid - [:date] ":method :url - HTTP/:http-version" :status :res[content-length] ":referrer" ":user-agent')}stream(e){return r.createWriteStream(a.join(__dirname,`../logs/${e}`),{flags:"a"})}accesLog(){return o.default.info("Generando archivo de logs -> acceso"),{skip:(e,{statusCode:t})=>!(t>=200&&t<300),stream:this.stream("access.log")}}errorLog(){return o.default.info("Generando archivo de logs -> error"),{skip:(e,{statusCode:t})=>t>=200&&t<300,stream:this.stream("error.log")}}}t.default=d},5933:function(e,t,s){var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(n,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getUserInfo=t.verifyIntegrityFacebookToken=t.getAccessToken=void 0;const n=s(8404),o=s(4405);t.getAccessToken=()=>i(void 0,void 0,void 0,(function*(){const e=`https://graph.facebook.com/oauth/access_token?         client_id=${n.FACEBOOK_CLIENT_ID}         &client_secret=${n.FACEBOOK_CLIENT_SECRET}         &grant_type=client_credentials`;return yield o.fetch({url:e.replace(/ /g,"")}).then((e=>e.data))})),t.verifyIntegrityFacebookToken=(e,t)=>i(void 0,void 0,void 0,(function*(){const s=`https://graph.facebook.com/debug_token?         input_token=${e}         &access_token=${t}`;return yield o.fetch({url:s.replace(/ /g,"")}).then((e=>e.data)).then((e=>e.data))})),t.getUserInfo=(e,t)=>i(void 0,void 0,void 0,(function*(){const s=`https://graph.facebook.com/${e}         ?fields=${["id","email","name","first_name","last_name","picture.width(500).height(500)"].toString()}         &access_token=${t}`,i=yield o.fetch({url:s.replace(/ /g,"")}).then((e=>e.data));return{facebook:!0,email:i.email,img:i.picture.data.url,name:i.first_name,lastname:i.last_name}}))},9571:function(e,t,s){var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(n,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.verifyGoogleTokenAndgetPayload=void 0;const n=s(6781),o=s(8404),a=new n.OAuth2Client(o.GOOGLE_CLIENT_ID);t.verifyGoogleTokenAndgetPayload=e=>i(void 0,void 0,void 0,(function*(){const t=(yield a.verifyIdToken({idToken:e,audience:o.GOOGLE_CLIENT_ID})).getPayload(),s=null==t?void 0:t.name;return{name:null==s?void 0:s.split(" ")[0].toLocaleLowerCase(),lastname:null==s?void 0:s.split(" ")[1].toLocaleLowerCase(),img:null==t?void 0:t.picture,email:null==t?void 0:t.email,google:!0}}))},6623:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TYPES_VALIDATIONS=void 0,t.TYPES_VALIDATIONS={email:{field:"email",msg:"Tu correo electrónico es necesario!"},password:{field:"password",msg:"La contraseña es obligatoria! y debe contener al menos 8 caracteres"},newPassword:{field:"newPassword",msg:"La nueva contraseña es necesaria! y debe contener al menos 8 caracteres"},username:{field:"username",msg:"Necesitamos conocer tu nombre de usuario, recuerda que debe tener al menos 5 caracteres"},name:{field:"name",msg:"Necesitamos saber cual es tu nombre"},lastName:{field:"lastname",msg:"Necesitamos conocer tu apellido"},roles:{field:"roles",msg:"Cual es el rol que desempeña?"},search:{field:"input",msg:"Ingresa un termino de búsqueda"}}},7789:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.acentosRegexp=t.isLocalAccount=void 0,t.isLocalAccount=e=>{let t=!0,s="una cuenta local";return(e.google||e.facebook)&&(t=!1,e.google&&(s="google"),e.facebook&&(s="facebook")),{localAccount:t,typeAccount:s}},t.acentosRegexp=e=>e.replace("/a/g","[a,á,à,â,ä").replace("/e/g","[e,é,è,ê,ë]").replace("/i/g","[i,í,ì,î,ï]").replace("/o/g","[o,ó,ò,ô,ö]").replace("/u/g","[u,ú,ù,û,ü]")},3607:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(s(1580)),o=i(s(4053)),a=s(8404),r=i(s(9050));(()=>{const e=n.default.init();e.Connect((()=>{r.default.warn("Iniciando prueba de conexión para la base de datos"),o.default.init(a.PORT,a.APP_NAME).listenSSLServer()})).then((()=>e.Disconnect((()=>r.default.warn("Cerrando prueba de conexión para la base de datos")))))})()},9071:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.adminVerify=void 0;const n=i(s(9050));t.adminVerify=(e,t,s)=>{const{roles:i,uid:o}=e.decoded;return i&&!i.includes("admin")?(n.default.error(`Se bloqueo el intento de acceso a recursos de administrador al usuario ${o}`),t.status(401).json({ok:!1,msg:"No tienes suficientes permisos para continuar con esta acción!"})):s()}},7077:function(e,t,s){var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(n,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}c((i=i.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.typeTokenRefresh=t.typeTokenAccess=t.verifyToken=t.verifyTokenForgotPassword=t.verifyJWT=void 0;const o=s(9344),a=s(8404),r=n(s(2260));t.verifyJWT=(e,s,n)=>i(void 0,void 0,void 0,(function*(){const i=e.header("x-token"),o=e.header("x-type-token");if(!i||!o)return s.status(400).json({ok:!1,msg:"El token o la información del tipo de token no existe!"});try{const s=yield t.verifyToken(i,"access"===o?a.SEED_ACCESS_TOKEN:a.SEED_REFRESH_TOKEN).catch((e=>{throw"jwt expired"===e.message&&(e=Object.assign(Object.assign({},e),{status:401})),e}));return e.decoded=s,n()}catch(t){t.status||(t.status=500),r.default(t,e,s)}})),t.verifyTokenForgotPassword=(e,s,n)=>i(void 0,void 0,void 0,(function*(){try{const s=e.header("x-token");if(!s)throw{status:400,msg:"El token es necesario"};const i=yield t.verifyToken(s,a.SEED_FORGOT_PASSWORD_TOKEN).catch((e=>{throw"jwt expired"===e.message&&(e={status:400,msg:"Lo sentimos el token ha expirado, por favor empieza el proceso nuevamente!"}),e}));return e.decoded=i,n()}catch(t){t.status||(t.status=500),r.default(t,e,s)}})),t.verifyToken=(e,t)=>new Promise(((s,i)=>{o.verify(e,t,((e,t)=>e?i(e):s(t)))})),t.typeTokenAccess=(e,t,s)=>"access"!==e.header("x-type-token")?t.status(400).json({ok:!1,msg:"El tipo de token es invalido para esta petición!"}):s(),t.typeTokenRefresh=(e,t,s)=>"refresh"!==e.header("x-type-token")?t.status(400).json({ok:!1,msg:"El tipo de token es invalido para esta petición!"}):s()},8908:function(e,t,s){var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(n,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}c((i=i.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.apiLimiter=void 0;const o=n(s(1244)),a=s(9588),r=n(s(2260)),c=n(s(9050)),d=o.default.init();t.apiLimiter=(e,t,s)=>i(void 0,void 0,void 0,(function*(){try{const i=yield a.getIP(e);if(!i)return t.status(500).json({ok:!1,msg:"Something went wrong!"});yield d.limiterAPI.consume(i).catch((e=>{throw c.default.warn(`Se bloqueó el acceso a la IP ${i} por intentar realizar demasiadas solicitudes concurrentemente`),{status:429,msg:"Ho no, intenta otra vez en unos segundos, has sido bloqueado temporalmente por intentar realizar demasiadas solicitudes"}})),s()}catch(s){r.default(s,e,t)}}))},9738:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isLoginVal=void 0;const i=s(4119);t.isLoginVal=()=>[i.emailVal(),i.passwordVal()]},4119:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.areValidFields=t.newPasswordVal=t.Username=t.Roles=t.LastName=t.Search=t.Name=t.passwordVal=t.emailVal=void 0;const i=s(3553),n=s(6623),{email:o,password:a,name:r,newPassword:c,username:d,lastName:l,roles:u,search:h}=n.TYPES_VALIDATIONS;t.emailVal=()=>{const{field:e,msg:t}=o;return i.check(e,t).isEmail().not().isEmpty().normalizeEmail()},t.passwordVal=()=>{const{field:e,msg:t}=a;return i.check(e,t).not().isEmpty().isString().trim().escape()},t.Name=()=>{const{field:e,msg:t}=r;return i.check(e,t).not().isEmpty().isString().trim().escape()},t.Search=()=>{const{field:e,msg:t}=h;return i.check(e,t).not().isEmpty().isString().trim().escape()},t.LastName=()=>{const{field:e,msg:t}=l;return i.check(e,t).not().isEmpty().isString().trim().escape()},t.Roles=()=>{const{field:e,msg:t}=u;return i.check(e,t).not().isEmpty().isArray()},t.Username=()=>{const{field:e,msg:t}=d;return i.check(e,t).not().isEmpty().isString().isLength({min:5}).trim().escape()},t.newPasswordVal=()=>{const{field:e,msg:t}=c;return i.check(e,t).not().isEmpty().isString().isLength({min:8}).trim().escape()},t.areValidFields=(e,t,s)=>{const n=i.validationResult(e);return n.isEmpty()?s():t.status(400).json({ok:!1,err:n.formatWith((({location:e,msg:t,param:s,value:i,nestedErrors:n})=>`${t}`)).mapped()})}},4262:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isUpdatePasswordVal=t.isUpdateUserAdminVal=t.isUserVal=void 0;const i=s(4119);t.isUserVal=()=>[i.Name(),i.emailVal(),i.passwordVal()],t.isUpdateUserAdminVal=()=>[i.Name(),i.LastName(),i.Username(),i.Roles()],t.isUpdatePasswordVal=()=>[i.passwordVal(),i.newPasswordVal()]},700:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(s(3588)),o=s(7077),a=s(9071),r=s(4262),c=s(4119),d=i(s(9050)),l=i(s(5520));class u extends n.default{constructor(){super(),this.service=l.default.init(),this.path="/admin",this.init()}static init(){return d.default.warn("Iniciando nueva instancia del punto de acceso a administradores"),new u}init(){this.Router.use([o.verifyJWT,o.typeTokenAccess,a.adminVerify]),this.Router.route(`${this.path}`).get(this.service.getAllUsers).post([...r.isUserVal(),c.areValidFields],this.service.createAdminUser).put(this.service.updateUserAdmin),this.Router.route(`${this.path}/delete/:id`).delete(this.service.deleteUser),this.Router.route(`${this.path}/user/lock/:uid/:type`).put(this.service.lockUser),this.Router.route(`${this.path}/state/:type`).get(this.service.filterUserLock),this.Router.route(`${this.path}/search/:type`).get([c.Search(),c.areValidFields],this.service.searchUser),this.Router.route(`${this.path}/password/:uid`).put(this.service.updatePassword),this.Router.route(`${this.path}/course/students`).post(this.service.getStudents),this.Router.route(`${this.path}/course/teacher`).get(this.service.getTeachers),this.Router.route(`${this.path}/dashboard`).get(this.service.getDashboardAdmin)}}t.default=u},7345:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(s(3588)),o=i(s(9050)),a=i(s(287)),r=s(7077),c=s(9738),d=s(4119);class l extends n.default{constructor(){super(),this.LocalAuth=()=>{this.Router.route(`${this.path}/login`).post([...c.isLoginVal(),d.areValidFields],this.service.login),this.Router.route(`${this.path}/list/token/refresh/:uid`).get(this.service.getSessionUser),this.Router.route(`${this.path}/sessions/delete`).delete(this.service.deleteSessions),this.Router.route(`${this.path}/logout`).get([r.verifyJWT,r.typeTokenRefresh],this.service.logout),this.Router.route(`${this.path}/refresh`).put([r.verifyJWT,r.typeTokenRefresh],this.service.refreshToken),this.Router.route(`${this.path}/forgot/password`).post([d.emailVal(),d.areValidFields],this.service.forgotPassword).put([r.verifyTokenForgotPassword,d.newPasswordVal(),d.areValidFields],this.service.updateForgotPassword),this.Router.route(`${this.path}/revoke`).delete([r.verifyJWT,r.typeTokenRefresh],this.service.revokeRefreshToken)},this.SocialAuth=()=>{this.Router.route(`${this.path}/login/google`).post(this.service.loginGoogle),this.Router.route(`${this.path}/login/facebook`).post(this.service.loginFacebook)},this.service=a.default.init(),this.path="/auth",this.init()}static init(){return o.default.warn("Iniciando nueva instancia del punto de acceso de autenticación"),new l}init(){this.LocalAuth(),this.SocialAuth()}}t.default=l},8479:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(s(7345)),o=i(s(8558)),a=i(s(700));t.default=[n.default.init().Router,o.default.init().Router,a.default.init().Router]},3588:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0});const i=s(6860);class n{constructor(){this.router=i.Router()}static init(){return new n}get Router(){return this.router}}t.default=n},8558:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(s(3588)),o=i(s(7440)),a=s(7077),r=s(4262),c=s(4119),d=i(s(9050));class l extends n.default{constructor(){super(),this.service=o.default.init(),this.path="/users",this.init()}static init(){return d.default.warn("Iniciando nueva instancia del punto de acceso a usuarios"),new l}init(){this.usersCRUD(),this.Email(),this.Password(),this.Img(),this.Comments()}Img(){this.Router.route(`${this.path}/update/avatar`).put([a.verifyJWT,a.typeTokenAccess],this.service.updateAvatar),this.Router.route(`${this.path}/avatar/:name`).get(this.service.getAvatar),this.Router.route(`${this.path}/update/portada`).put([a.verifyJWT,a.typeTokenAccess],this.service.updatePortada),this.Router.route(`${this.path}/portada/:name`).get(this.service.getPortada)}Email(){this.Router.route(`${this.path}/email/update`).put([a.verifyJWT,a.typeTokenAccess,c.emailVal(),c.areValidFields],this.service.updateEmail),this.Router.route(`${this.path}/email/confirm`).post([a.verifyJWT,a.typeTokenAccess],this.service.confirmEmail),this.Router.route(`${this.path}/email/generatecode`).get([a.verifyJWT,a.typeTokenAccess],this.service.generateCodeConfirmEmail)}usersCRUD(){this.Router.route(`${this.path}`).post([...r.isUserVal(),c.areValidFields],this.service.createUser),this.Router.route(`${this.path}/update`).put([a.verifyJWT,a.typeTokenAccess],this.service.updateUser),this.Router.route(`${this.path}/info/:uid`).get(this.service.getUserById),this.Router.route(`${this.path}/reports`).put([a.verifyJWT,a.typeTokenAccess],this.service.startGetUsersById)}Password(){this.Router.route(`${this.path}/password/update`).put([a.verifyJWT,a.typeTokenAccess,...r.isUpdatePasswordVal(),c.areValidFields],this.service.updatePassword)}Comments(){this.Router.route(`${this.path}/comments`).post(this.service.getStudentsByCollectionId)}}t.default=l},6557:function(e,t,s){var i=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&i(t,e,s);return n(t,e),t},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(s(6860)),c=s(8908),d=a(s(9470)),l=a(s(7093)),u=a(s(7806)),h=a(s(3582)),m=a(s(9050)),p=a(s(6674)),_=a(s(1890));t.default=class{constructor(e,t){this.app=r.default(),this.port=e,this.nameapp=t,this.morganConfig=l.default.init(),this.OnInitMiddlewares()}OnInitMiddlewares(){this.IP(),this.Security(),this.ApiLimiter(),this.bodyParser(),this.log_register(),this.Files()}bodyParser(){m.default.info("Configurando middleware para formatear información del cuerpo de peticiones"),this.app.use(r.urlencoded({extended:!0})),this.app.use(r.json())}ApiLimiter(){m.default.warn("Configurando middleware limitador de la API"),this.app.use(c.apiLimiter)}IP(){this.app.set("trust proxy",!0)}log_register(){this.app.use(d.default("personalizado",this.morganConfig.accesLog())),this.app.use(d.default("personalizado",this.morganConfig.errorLog()))}Security(){m.default.warn("Configurando middleware para seguridad en la API"),this.app.use(u.default()),this.app.use(h.default({origin:_.default()}))}Files(){this.app.use(p.default())}get Port(){return this.port}get App(){return this.app}get NameApp(){return this.nameapp}}},4053:function(e,t,s){var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(n,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}c((i=i.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(s(9050)),a=n(s(6557)),r=n(s(8479)),c=n(s(3685)),d=n(s(5687)),l=s(7210);class u extends a.default{constructor(e,t){super(e,t),this.endpoint=r.default,this.OnInit()}static init(e,t){return this.instance||(this.instance=new u(e,t)),this.instance}OnInit(){this.EndPoints()}EndPoints(){this.app.use("/api/v1",this.endpoint)}listenServer(e){return c.default.createServer(this.app).listen(this.port,(()=>e?e():o.default.info(`Escuchando aplicación ${this.NameApp} en el puerto ${this.Port}`)))}listenSSLServer(e){return i(this,void 0,void 0,(function*(){const t={key:l.serverKey,cert:l.serverCert};return d.default.createServer(t,this.app).listen(this.port,(()=>e?e():o.default.info(`Escuchando aplicación ${this.NameApp} en el puerto ${this.Port}`)))}))}}t.default=u},5520:function(e,t,s){var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(n,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}c((i=i.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(s(5042)),a=n(s(1324)),r=n(s(1999)),c=n(s(2260)),d=s(7147),l=s(1017),u=s(7789),h=n(s(9050));class m extends r.default{constructor(){super(),this.createAdminUser=(e,t)=>i(this,void 0,void 0,(function*(){const s=e.body;try{yield this.db.Connect();const e=new o.default(s);yield e.save().catch((e=>{throw{status:400,msg:e.message.substring(e.message.lastIndexOf(":")+1,e.message.length).trim()}})),["users","usersLock","usersUnlock"].forEach((e=>this.RedisToken.removeDataInCache(e))),yield this.db.Disconnect();let i={from:{name:"servicio automático",address:"no-reply@ierec.com"},to:[s.email],subject:"Contraseña !",html:`<p>\n                    Hola <strong>${s.name}</strong> un administrador ha creado una nueva cuenta para tí en la plataforma IERec                     esta es tu nueva contraseña: <strong>${s.password}</strong>\n                </p>`};return yield this.Email.sendMail(i).catch((e=>{throw{status:400,msg:"Algo salió mal!",err:e}})),t.json({ok:!0,msg:"La contraseña ha sido enviada al correo electrónico del usuario!"})}catch(s){yield this.db.Disconnect(),c.default(s,e,t)}})),this.updateUserAdmin=(e,t)=>i(this,void 0,void 0,(function*(){try{const s=e.query.uid;if(!s)throw{status:400,msg:"No existe el id del usuario"};yield this.db.Connect();const i=yield o.default.findById(s).catch((e=>{throw{status:500,msg:"Algo salió mal!"}}));if(!i)throw{status:404,msg:"No se encontró el usuario!"};let{name:n,lastname:a,username:r,roles:c}=e.body;return yield i.updateOne({name:n,lastname:a,username:r,roles:c},{runValidators:!1,strict:!0}).catch((()=>{throw{status:500,msg:"Algo salió mal"}})),yield this.db.Disconnect(),["users","usersLock","usersUnlock"].forEach((e=>this.RedisToken.removeDataInCache(e))),t.json({ok:!0,msg:"usuario actualizado!"})}catch(s){yield this.db.Disconnect(),c.default(s,e,t)}})),this.getAllUsers=(e,t)=>i(this,void 0,void 0,(function*(){try{const{page:s}=e.query||1,i=yield this.RedisToken.getDataInCache("users",String(s)).catch((()=>{throw{status:500,msg:"Algo salió mal"}}));if(i)return t.json(Object.assign({ok:!0,type:"cache"},JSON.parse(i)));{yield this.db.Connect();const{docs:e,totalDocs:i}=yield o.default.paginate({},{page:Number(s),limit:10,select:["-emailConfirm","-greetingWelcome","-country"]}).catch((()=>{throw{status:500,msg:"Algo salió mal!"}}));if(yield this.db.Disconnect(),e.length<=0||!e)throw{status:404,msg:"No se encontraron usuarios!"};return this.RedisToken.saveDataInCache("users",String(s),JSON.stringify({numRegistros:i,users:e})),t.json({ok:!0,type:"database",numRegistros:i,users:e})}}catch(s){yield this.db.Disconnect(),c.default(s,e,t)}})),this.deleteUser=(e,t)=>i(this,void 0,void 0,(function*(){try{yield this.db.Connect();const{id:s}=e.params,{msg:i}=e.body,n=yield o.default.findByIdAndDelete(s,{runValidators:!0,new:!1}).catch((()=>{throw{status:500,msg:"Algo salió mal!"}}));if(!n)throw{status:404,msg:"No se encuentra el usuario"};const r=yield a.default.find({user:n._id}).catch((e=>{throw{status:500,msg:"Algo salió mal!"}}));if(r)for(const e in r)yield r[e].remove();yield this.db.Disconnect();let c=l.resolve(__dirname,`../files/avatars/${n.img}`);d.existsSync(c)&&d.unlinkSync(c);let u={from:{name:"IERec no-reply",address:"no-reply@ierec.com"},to:[n.email],subject:"Eliminación de cuenta !",html:`<p>\n                    Hola <strong>${n.username}</strong> un administrador ha decidido eliminar tu cuenta de la plataforma IERec.\n                </p>\n                ${i&&`\n                    <h4>Los motivos son:</h4>\n                    <p>${i}</p>    \n                `}`};return yield this.Email.sendMail(u).catch((()=>{throw{status:400,msg:"Algo salió mal!"}})),["users","usersLock","usersUnlock"].forEach((e=>this.RedisToken.removeDataInCache(e))),t.status(200).json({ok:!0,msg:"Usuario eliminado!"})}catch(s){yield this.db.Disconnect(),c.default(s,e,t)}})),this.lockUser=(e,t)=>i(this,void 0,void 0,(function*(){try{const{uid:s,type:i}=e.params;if(!s)throw{status:404,msg:"No existe el id del usuario"};if(!i)throw{status:404,msg:"Que tipo de operación se debe realizar?, bloqueo o desbloqueo?, por favor incluya el tipo"};yield this.db.Connect();const n=yield o.default.findById(s).catch((()=>{throw{status:500,msg:"Algo salió mal!"}}));if(!n)throw{status:404,msg:"No se encontró el usuario!"};let a={};if("lock"===i)a={state:!1};else{if("unlock"!==i)throw{status:400,msg:"incluya un tipo valido, las opciones disponibles son: lock & unlock"};a={state:!0}}return yield n.updateOne(a,{runValidators:!1}).catch((()=>{throw{status:500,msg:"Algo salió mal"}})),["users","usersLock","usersUnlock"].forEach((e=>this.RedisToken.removeDataInCache(e))),yield this.db.Disconnect(),t.json({ok:!0,msg:"operación completada!"})}catch(s){yield this.db.Disconnect(),c.default(s,e,t)}})),this.filterUserLock=(e,t)=>i(this,void 0,void 0,(function*(){try{const s=e.params.type,{page:i}=e.query||1;if(!s)throw{status:400,msg:"Querías filtrar por usuarios bloqueados o activos?, por favor especifíca el tipo"};let n;n="lock"===s?"usersLock":"usersUnlock";const a=yield this.RedisToken.getDataInCache(n,String(i)).catch((()=>{throw{status:500,msg:"Algo salió mal"}}));if(a)return t.json(Object.assign({ok:!0,type:"cache"},JSON.parse(a)));{yield this.db.Connect();const{docs:e,totalDocs:a}=yield o.default.paginate("lock"===s?{state:!1}:{state:!0},{page:Number(i),limit:12}).catch((()=>{throw{status:500,msg:"Algo salió mal!"}}));if(yield this.db.Disconnect(),e.length<=0||!e)throw{status:404,msg:"No se encontraron usuarios!"};return this.RedisToken.saveDataInCache(n,String(i),JSON.stringify({numRegistros:a,users:e})),t.json({ok:!0,type:"database",numRegistros:a,users:e})}}catch(s){yield this.db.Disconnect(),c.default(s,e,t)}})),this.searchUser=(e,t)=>i(this,void 0,void 0,(function*(){try{const s=e.query.page||1,i=e.params.type,n=e.query.input;if(!["email","username","roles","_id"].includes(i)||!i)throw{status:404,msg:"Ingresa un tipo búsqueda válido!"};const a=new RegExp(u.acentosRegexp(n),"i");if(yield this.db.Connect(),"_id"===i){const e=yield o.default.findById(n).catch((()=>{throw{status:400,msg:"Algo salió mal!"}}));return t.json({ok:!0,users:[e]})}const{docs:r,totalDocs:c}=yield o.default.paginate({[i]:{$regex:a}},{page:Number(s),limit:12}).catch((()=>{throw{status:500,msg:"Algo salió mal!"}}));return yield this.db.Disconnect(),t.json({ok:!0,numRegistros:c,users:r})}catch(s){yield this.db.Disconnect(),c.default(s,e,t)}})),this.updatePassword=(e,t)=>i(this,void 0,void 0,(function*(){try{const i=e.params.uid;yield this.database.Connect();const n=yield o.default.findById(i).catch((()=>{throw{status:500,msg:"Algo salió mal!"}}));if(!n)throw{status:404,msg:"No se encontró el usuario!"};var s=Math.floor(9e7*Math.random())+1e7;yield n.updateOne({password:String(`Pass-${s}`)},{runValidators:!1}).catch((()=>{throw{status:500,msg:"Algo salió mal!"}}));let a={from:{name:"servicio automático",address:"no-reply@ierec.com"},to:[n.email],subject:"!",html:`<p>\n                    Hola <strong>${n.username}</strong> un administrador ha generado una nueva contraseña para acceder a la plataforma IERec                     esta es tu nueva contraseña: <strong>Pass-${s}</strong>\n                </p>\n                <p>No te preocupes por la integridad de dicha contraseña, sin embargo, sugerimos que la cambies cuando entres al sistema.</p>`};return yield this.Email.sendMail(a).catch((()=>{throw{status:500,msg:"Algo salió mal!"}})),t.json({ok:!0,msg:"La nueva contraseña se ha enviado al correo del usuario!"})}catch(s){this.database.Disconnect(),c.default(s,e,t)}})),this.getStudents=(e,t)=>i(this,void 0,void 0,(function*(){try{yield this.db.Connect();const s=e.body;let i=[];s.forEach((e=>i.push(e.estudiante)));const n=yield o.default.find({_id:{$in:i}}).sort({_id:-1}).populate({path:"country",select:["name","code"]}).select(["name","lastname","username","email","img","facebook","google","country","phone"]).catch((()=>{throw{status:400,msg:"Algo salió mal!"}}));return yield this.db.Disconnect(),t.json({ok:!0,students:n})}catch(s){yield this.db.Disconnect(),c.default(s,e,t)}})),this.getTeachers=(e,t)=>i(this,void 0,void 0,(function*(){try{yield this.db.Connect();const e=yield o.default.find({roles:"maestro"}).select(["name","lastname","username","email","img","facebook","google","username"]).catch((()=>{throw{status:400,msg:"Algo salió mal!"}}));if(!e)throw{status:404,msg:"No hay docentes disponibles"};return yield this.db.Disconnect(),t.json({ok:!0,teachers:e})}catch(s){yield this.db.Disconnect(),c.default(s,e,t)}})),this.getDashboardAdmin=(e,t)=>i(this,void 0,void 0,(function*(){try{yield this.db.Connect();const e=yield o.default.find({}).sort({_id:-1}).limit(5).select(["img","facebook","google","name","lastname","username","roles","country.name"]),s=yield o.default.aggregate([{$group:{_id:"$roles",count:{$sum:1}}}]).sort({_id:-1}),i=yield o.default.aggregate([{$group:{_id:"$country.name",count:{$sum:1}}}]).sort({_id:1});return t.json({ok:!0,users:e,usersCountByRol:s,usersCountByCountry:i})}catch(s){yield this.db.Disconnect(),c.default(s,e,t)}}))}static init(){return h.default.warn("Iniciando nueva instancia del servicio Admin"),new m}}t.default=m},287:function(e,t,s){var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(n,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}c((i=i.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(s(5042)),a=n(s(1324)),r=n(s(1999)),c=s(3142),d=s(9588),l=n(s(9050)),u=s(9571),h=s(5933),m=n(s(2260)),p=s(7789),_=s(9344),f=s(8404);class g extends r.default{constructor(){super(),this.login=(e,t)=>i(this,void 0,void 0,(function*(){try{const{password:s,email:i}=e.body;yield this.db.Connect();let n=yield o.default.findOne({email:i}).catch((()=>{throw{status:400,msg:"Algo salió mal!"}}));if(!n)throw{status:404,msg:"Lo sentimos!, no encontramos ninguna cuenta registrada con este email."};const r=p.isLocalAccount(n),{localAccount:l,typeAccount:u}=r;if(!l)throw{status:400,msg:`Esta cuenta esta registrada con ${u}`};if(!n.state)throw{status:400,msg:"Tu cuenta esta bloqueada, por favor, contacta a un administrador"};const h=n._id,m=yield d.getIP(e),_=yield this.Rate.limiterLogin.consume(h).catch((()=>{throw{status:400,msg:"Tu cuenta ha sido bloqueada, por favor, contacta a un administrador"}}));if(!(yield n.compareHash(s).catch((()=>{throw{status:400,msg:"Algo salió mal!"}})))){const{remainingPoints:e}=_;throw e<=0&&(["users","usersLock","usersUnlock"].forEach((e=>this.RedisToken.removeDataInCache(e))),yield n.updateOne({state:!1},{runValidators:!1}).catch((()=>{throw{status:400}}))),{status:400,msg:`Ingresaste una contraseña incorrecta, solo tienes ${e} intentos restantes`}}this.Rate.limiterLogin.delete(h);const f={uid:n._id,roles:n.roles,username:n.username,email:n.email,fullname:`${n.name} ${n.lastname}`,greetingWelcome:n.greetingWelcome,emailConfirm:n.emailConfirm,img:n.img,typeAccount:u,account:r,profesional_info:n.profesional_info},g=c.generateJWT("access",f),y=c.generateJWT("refresh",{uid:h}),v=new a.default({user:n._id,refreshToken:y,accessToken:g,ip:m});return yield v.save().catch((()=>{throw{status:500,msg:"Algo salió mal!"}})),yield this.db.Disconnect(),t.json({ok:!0,accessToken:g,refreshToken:y,idSession:v._id})}catch(s){yield this.db.Disconnect(),m.default(s,e,t)}})),this.logout=(e,t)=>i(this,void 0,void 0,(function*(){try{const s=e.header("x-token");yield this.db.Connect();const i=yield a.default.findOne({refreshToken:s}).catch((e=>{throw{status:500,msg:"Algo salió mal!"}}));return i?(yield i.remove(),yield this.db.Disconnect(),t.json({ok:!0})):t.json({ok:!0})}catch(s){yield this.db.Disconnect(),m.default(s,e,t)}})),this.refreshToken=(e,t)=>i(this,void 0,void 0,(function*(){try{const s=e.header("x-token");yield this.database.Connect();const i=yield a.default.findOne({refreshToken:s}).catch((e=>{throw{status:400,msg:"Algo salió mal!",e}}));if(!i)throw{status:404,msg:"No se encuentra la sesión"};const{uid:n}=e.decoded,{uid:r}=_.decode(i.refreshToken);if(n!==r)throw{status:400,msg:"Este token no pertenece al usuario solicitante!"};const d=yield o.default.findById(n).catch((e=>{throw{status:400,msg:"Algo salió mal!",e}}));if(!d)throw{status:404,msg:"Algo salió mal!"};const{roles:l,username:u,email:h,greetingWelcome:m,emailConfirm:f,img:g,name:y,lastname:v,profesional_info:E}=d,k={uid:n,roles:l,username:u,email:h,fullname:`${y} ${v}`,greetingWelcome:m,emailConfirm:f,img:g,account:p.isLocalAccount(d),profesional_info:E},S=c.generateJWT("access",k);return yield i.updateOne({accessToken:S},{runValidators:!0,strict:!0}).catch((()=>{throw{status:400,msg:"Algo salió mal!"}})),yield this.database.Disconnect(),t.json({ok:!0,uid:n,accessToken:S,idSession:i._id})}catch(s){this.database.Disconnect(),m.default(s,e,t)}})),this.revokeRefreshToken=(e,t)=>i(this,void 0,void 0,(function*(){try{const s=e.header("x-token");this.database.Connect();const i=yield a.default.findOne({refreshToken:s}).catch((()=>{throw{status:400,msg:"Algo salió mal!"}}));if(!i)throw{status:404,msg:"No se encontró la sesión con el token enviado en la solicitud!"};const{uid:n}=e.decoded,{uid:o}=_.decode(i.refreshToken);if(n!==o)throw{status:400,msg:"Este token no pertenece al usuario solicitante!"};return yield i.remove(),this.database.Disconnect(),t.json({ok:!0,msg:"La sesión del usuario se eliminó correctamente!"})}catch(s){this.database.Disconnect(),m.default(s,e,t)}})),this.loginGoogle=(e,t)=>i(this,void 0,void 0,(function*(){try{const{tokenGoogle:s}=e.body;if(!s)throw{status:400,msg:"El token no existe!"};const i=yield u.verifyGoogleTokenAndgetPayload(s).catch((e=>{throw{status:403,msg:"Token inválido",e}}));yield this.db.Connect();let n=yield o.default.findOne({email:i.email}).catch((()=>{throw{status:500,msg:"Algo salio mal!"}})),a=null;if(n||(a=new o.default(Object.assign(Object.assign({},i),{username:i.name,password:"undefined",emailConfirm:!0,greetingWelcome:!0})),a.save(),n=a),!n)throw{status:400,msg:"Algo salió mal!"};yield n.updateOne({img:i.img,name:i.name,lastname:i.lastname},{runValidators:!1}).catch((()=>{throw{status:500,msg:"Algo salió mal!"}}));const{typeAccount:r}=p.isLocalAccount(n);if("google"!==r)throw{status:400,msg:`Esta cuenta esta registrada con ${r}`};return this.getTokens(n,{typeAccount:"google",isLocalAccount:!1},e,t)}catch(s){yield this.db.Disconnect(),m.default(s,e,t)}})),this.loginFacebook=(e,t)=>i(this,void 0,void 0,(function*(){try{const s=e.body.tokenFacebook;if(!s)throw{ok:!1,msg:"No existe el token"};const i=yield h.getAccessToken(),n=yield h.verifyIntegrityFacebookToken(s,i.access_token),a=n.user_id;if(!n.is_valid)throw{status:500,msg:"El token es invalido"};const r=yield h.getUserInfo(a,s);yield this.db.Connect();let c=yield o.default.findOne({email:r.email}).catch((()=>{throw{status:500,msg:"Algo salio mal!"}})),d=null;c||(d=new o.default(Object.assign(Object.assign({},r),{username:r.name,password:"undefined",emailConfirm:!0,greetingWelcome:!0})),d.save(),c=d),yield c.updateOne({img:r.img,name:r.name,lastname:r.lastname},{runValidators:!1}).catch((()=>{throw{status:500,msg:"Algo salió mal!"}}));const l=p.isLocalAccount(c),{typeAccount:u}=l;if("facebook"!==u)throw{status:400,msg:`Esta cuenta esta registrada con ${u}`};return this.getTokens(c,l,e,t)}catch(s){yield this.db.Disconnect(),m.default(s,e,t)}})),this.forgotPassword=(e,t)=>i(this,void 0,void 0,(function*(){try{yield this.db.Connect();const{email:s,host:i}=e.body,n=yield o.default.findOne({email:s}).catch((e=>{throw{status:400,msg:"Algo salió mal!",e}}));if(!n)throw{status:404,msg:"Usuario no encontrado"};const a=n._id,r=c.generateJWT("forgot-password",{uid:a});if(yield this.RedisToken.existForgotToken(a))throw{status:400,msg:"Ya se ha generado un proceso de recuperación de contraseña para esta cuenta, por favor revisa tu correo"};this.RedisToken.addForgotTokenToList(a,r);let d={from:{name:"servicio automático",address:"no-reply@ierec.com"},to:[n.email],subject:"Actualización de contraseña olvidada!",html:`Accede a este link para continuar con el proceso de recuperación de cuenta, el mismo sera válido por ${f.EXP_FORGOT_TOKEN/60} minutos antes de poder generar uno nuevo\n                    <br/><br/>\n                    ${i}?token=${r}\n                `};return yield this.Email.sendMail(d).catch((e=>{throw console.log(e),l.default.error(e.message),{status:400,msg:"Algo salió mal!",e}})),t.json({ok:!0,msg:"Se envió un token de actualización a la cuenta registrada con este correo electrónico,                 accede a él para continuar con el proceso"})}catch(s){yield this.db.Disconnect(),m.default(s,e,t)}})),this.updateForgotPassword=(e,t)=>i(this,void 0,void 0,(function*(){try{const s=e.header("x-token"),{uid:i}=e.decoded,{newPassword:n}=e.body;if((yield this.RedisToken.getForgotTokenFromList(i).catch((()=>{throw{status:500,msg:"Algo salió mal!"}})))!==s)throw{status:404,msg:"Token no pertenece a esta petición!"};this.RedisToken.removeForgotTokenFromList(i),yield this.db.Connect();const a=yield o.default.findById(i).catch((()=>{throw{status:400,msg:"Algo salió mal!"}}));if(!a)throw{status:404,msg:"Algo salió mal!"};return yield a.updateOne({password:n}).catch((()=>{throw{status:400,msg:"Algo salió mal!"}})),yield this.db.Disconnect(),t.json({ok:!0,msg:"Contraseña actualizada!"})}catch(s){yield this.db.Disconnect(),m.default(s,e,t)}})),this.getSessionUser=(e,t)=>i(this,void 0,void 0,(function*(){try{const s=e.params.uid;yield this.db.Connect();const i=yield a.default.find({user:s},"ip").catch((()=>{throw{status:500,msg:"Algo salió mal!"}}));if(!i)throw{status:404,msg:"El usuario no tiene sesiones activas"};return yield this.db.Disconnect(),t.json({ok:!0,sessions:i})}catch(s){yield this.db.Disconnect(),m.default(s,e,t)}})),this.deleteSessions=(e,t)=>i(this,void 0,void 0,(function*(){try{yield this.db.Connect();const s=e.body.sessions;return yield a.default.deleteMany({_id:{$in:s}}).catch((()=>{throw{status:400,msg:"Algo salió mal!"}})),yield this.db.Disconnect(),t.json({ok:!0,msg:"Se han revocado todas las sesiones seleccionadas"})}catch(s){yield this.db.Disconnect(),m.default(s,e,t)}}))}static init(){return l.default.warn("Iniciando nueva instancia del servicio Auth"),new g}getTokens(e,t,s,n){return i(this,void 0,void 0,(function*(){const i=e._id,o=e.roles,r=e.username,l=`${e.name} ${e.lastname}`,u=e.greetingWelcome,h=e.img,m=yield d.getIP(s),p={uid:i,roles:o,username:r,emailConfirm:!0,email:e.email,fullname:l,greetingWelcome:u,img:h,account:t},_=c.generateJWT("access",p),f=c.generateJWT("refresh",{uid:i}),g=new a.default({user:e._id,refreshToken:f,accessToken:_,ip:m});return yield g.save().catch((()=>{throw{status:500,msg:"Algo salió mal!"}})),yield this.db.Disconnect(),n.json({ok:!0,accessToken:_,refreshToken:f,idSession:g._id})}))}}t.default=g},1999:function(e,t,s){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(s(1580)),o=i(s(7689)),a=i(s(8014)),r=i(s(1244));t.default=class{constructor(){this.database=n.default.init(),this.redisToken=o.default.init(),this.email=a.default.init(),this.rate=r.default.init()}get db(){return this.database}get RedisToken(){return this.redisToken}get Email(){return this.email}get Rate(){return this.rate}}},7440:function(e,t,s){var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))((function(n,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function r(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,r)}c((i=i.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(s(5042)),a=n(s(1324)),r=n(s(1999)),c=s(3142),d=s(7147),l=s(1017),u=s(9588),h=n(s(2260)),m=s(7789),p=n(s(9050));class _ extends r.default{constructor(){super(),this.createUser=(e,t)=>i(this,void 0,void 0,(function*(){try{const s=e.body;if(s.roles&&s.roles.includes("admin"))throw{status:401,msg:"El rol del usuario no puede ser administrador!"};yield this.db.Connect();const i=new o.default(s),n=yield i.save().catch((e=>{throw{status:400,msg:e.message.substring(e.message.lastIndexOf(":")+1,e.message.length).trim()}}));["users","usersLock","usersUnlock"].forEach((e=>this.RedisToken.removeDataInCache(e)));const r=n._id,d=yield u.getIP(e),l=m.isLocalAccount(n),h={uid:r,roles:n.roles,username:n.username,email:n.email,fullname:`${n.name} ${n.lastname}`,greetingWelcome:n.greetingWelcome,emailConfirm:n.emailConfirm,img:n.img,account:l},p=c.generateJWT("access",h),_=c.generateJWT("refresh",h),f=new a.default({user:n._id,refreshToken:_,accessToken:p,ip:d});return yield f.save().catch((e=>{throw{status:500,msg:"Algo salió mal!"}})),yield this.db.Disconnect(),t.json({ok:!0,accessToken:p,refreshToken:_,idSession:f._id})}catch(s){yield this.db.Disconnect(),h.default(s,e,t)}})),this.updateUser=(e,t)=>i(this,void 0,void 0,(function*(){try{yield this.db.Connect();const{uid:s}=e.decoded,i=yield o.default.findById(s);if(!i)throw{status:404,msg:"No se encontró el usuario!"};if(i._id.toString()!==s)throw{status:401,msg:"No tienes permisos para actualizar este usuario!"};const n=e.body;delete n.email;const a=yield o.default.findByIdAndUpdate(i._id,n,{runValidators:!0,strict:!0,new:!0}).catch((e=>{throw{status:500,msg:"Algo salió mal",e}}));return yield this.db.Disconnect(),["users","usersLock","usersUnlock"].forEach((e=>this.RedisToken.removeDataInCache(e))),t.json({ok:!0,msg:"usuario actualizado!",name:null==a?void 0:a.name,lastname:null==a?void 0:a.lastname,username:null==a?void 0:a.username})}catch(s){console.log(s),yield this.db.Disconnect(),h.default(s,e,t)}})),this.updateAvatar=(e,t)=>i(this,void 0,void 0,(function*(){try{const s=e.files;if(!s)throw{status:404,msg:"No existen archivos para procesar."};const i=s.avatar;if(!i)throw{status:404,msg:"No existe la imagen en la petición!"};this.updateImg(e,t,i,"avatars")}catch(s){h.default(s,e,t)}})),this.updatePortada=(e,t)=>i(this,void 0,void 0,(function*(){try{const s=e.files;if(!s)throw{status:404,msg:"No existen archivos para procesar."};const i=s.portada;if(!i)throw{status:404,msg:"No existe la imagen en la petición!"};this.updateImg(e,t,i,"portadas")}catch(s){h.default(s,e,t)}})),this.updateImg=(e,t,s,n)=>i(this,void 0,void 0,(function*(){try{yield this.db.Connect();const{uid:i}=e.decoded,a=yield o.default.findById(i);if(!a)throw{status:404,msg:"Algo salió mal!"};const r=l.resolve(__dirname,"..",`./files/${n}`);d.existsSync(r)||d.mkdirSync(r,{recursive:!0}),a.img&&d.existsSync(`${r}/${a.img}`)&&d.unlinkSync(`${r}/${a.img}`),s.mv(`${r}/${s.name}`);let c={};if("avatars"===n)c={img:s.name};else{if("portadas"!==n)throw{status:400,msg:"Tipo de imagen incorrecto!"};c={portada:s.name}}return yield a.updateOne(c,{runValidators:!0,strict:!0}).catch((()=>{throw{status:500,msg:"Algo salio mal!"}})),yield this.db.Disconnect(),["users","usersLock","usersUnlock"].forEach((e=>this.RedisToken.removeDataInCache(e))),t.json({ok:!0,img:s.name,localAccount:m.isLocalAccount(a)})}catch(s){yield this.db.Disconnect(),h.default(s,e,t)}})),this.getPortada=(e,t)=>i(this,void 0,void 0,(function*(){try{const{name:s}=e.params,i=l.resolve(__dirname,"..",`./files/portadas/${s}`);if(!d.existsSync(i))throw{status:404,msg:"No se encuentra el archivo de imagen"};return t.sendFile(i)}catch(s){h.default(s,e,t)}})),this.getAvatar=(e,t)=>i(this,void 0,void 0,(function*(){try{const{name:s}=e.params,i=l.resolve(__dirname,"..",`./files/avatars/${s}`);if(!d.existsSync(i))throw{status:404,msg:"No se encuentra el archivo de imagen"};return t.sendFile(i)}catch(s){h.default(s,e,t)}})),this.updatePassword=(e,t)=>i(this,void 0,void 0,(function*(){try{const{uid:s}=e.decoded;yield this.db.Connect();const i=yield o.default.findById(s).catch((()=>{throw{status:500,msg:"Algo salió mal!"}}));if(!i)throw{status:404,msg:"No se encuentra el usuario"};const{password:n,newPassword:a}=e.body;if(i._id.toString()!==s)throw{status:400,msg:"No puedes actualizar este usuario!"};const r=yield i.compareHash(n).catch((()=>{throw{status:500,msg:"Algo salió mal!"}})),c=yield this.Rate.limiterLogin.consume(s).catch((()=>{throw{status:500,msg:"Tu cuenta ha sido bloqueada temporalmente por favor intentalo de nuevo más tarde"}}));if(!r){const{remainingPoints:e}=c;throw e<=0&&(["users","usersLock","usersUnlock"].forEach((e=>this.RedisToken.removeDataInCache(e))),yield i.updateOne({state:!1},{runValidators:!1}).catch((()=>{throw{status:400}}))),{status:400,msg:`Tu antigua contraseña es incorrecta, solo tienes ${e} intentos restantes antes de ser bloqueado.`}}return yield i.updateOne({password:a},{runValidators:!0}).catch((()=>{throw{status:400,msg:"Algo salió mal!"}})),yield this.db.Disconnect(),t.json({ok:!0,msg:"contraseña actualizada!"})}catch(s){yield this.db.Disconnect(),h.default(s,e,t)}})),this.updateEmail=(e,t)=>i(this,void 0,void 0,(function*(){try{const{email:s,password:i}=e.body,{uid:n}=e.decoded;yield this.db.Connect();const a=yield o.default.findById(n).catch((()=>{throw{status:500,msg:"Algo salió mal!"}}));if(!a)throw{status:404,msg:"No se encuentra el usuario"};if(a._id.toString()!==n)throw{status:400,msg:"No puedes actualizar este usuario!"};const r=yield a.compareHash(i).catch((()=>{throw{status:500,msg:"Algo salió mal!"}})),c=yield this.Rate.limiterLogin.consume(n).catch((()=>{throw{status:500,msg:"Tu cuenta ha sido bloqueada, por favor contacta con un administrador"}}));if(!r){const{remainingPoints:e}=c;throw e<=0&&(["users","usersLock","usersUnlock"].forEach((e=>this.RedisToken.removeDataInCache(e))),yield a.updateOne({state:!1},{runValidators:!1}).catch((()=>{throw{status:400}}))),{status:400,msg:`Tu contraseña es incorrecta, solo tienes ${e} intentos restantes antes de ser bloqueado.`}}let d={email:s};if(a.email===s)throw{status:400,msg:"Este correo electrónico ya esta registrado con tu cuenta"};return yield a.updateOne(d,{strict:!0,runValidators:!0}).catch((e=>{throw{status:400,msg:e.message.substring(e.message.lastIndexOf(":")+1,e.message.length).trim()}})),yield this.db.Disconnect(),t.json({ok:!0,msg:"Email actualizado"})}catch(s){yield this.db.Disconnect(),h.default(s,e,t)}})),this.confirmEmail=(e,t)=>i(this,void 0,void 0,(function*(){try{const{code:s}=e.body;if(!s)throw{status:404,msg:"No existe el código!"};const{uid:i}=e.decoded,n="El código generado ya fue consumido o el mismo ya expiró!, \n            no te preocupes, puedes confirmar tu correo accediendo a tu perfil",a=yield this.RedisToken.getCodeConfirm(i).catch((()=>{throw{status:400,msg:n}}));if(!a)throw{status:404,msg:n};if(String(a)!==String(s))throw{status:404,msg:"El código es inválido!"};return this.RedisToken.removeCodeConfirm(i),yield this.database.Connect(),yield o.default.findByIdAndUpdate(i,{emailConfirm:!0},{runValidators:!0}),yield this.database.Disconnect(),t.json({ok:!0,msg:"Tu correo electrónico ha sido confirmado!"})}catch(s){h.default(s,e,t)}})),this.generateCodeConfirmEmail=(e,t)=>i(this,void 0,void 0,(function*(){try{const{uid:i,email:n,fullname:o}=e.decoded;if(yield this.RedisToken.getCodeConfirm(i))throw{status:400,ok:!0,msg:"Ya se ha enviado un código de confirmación a tu correo, intenta generar el nuevo código en un momento"};var s=Math.floor(9e4*Math.random())+1e4;this.RedisToken.saveCodeConfirm(i,String(s));let a={from:{name:"servicio automático",address:"no-reply@ierec.com"},to:[n],subject:"Código de confirmación!",html:`<p>\n                    Hola <strong>${o}</strong> Este es el código que necesitas para confirmar                     tu correo electrónico: <strong>G-${s}</strong>\n                </p>\n                <p>Recuerda que este código es valido por 5 minutos</p>`};return yield this.Email.sendMail(a).catch((()=>{throw{status:500,msg:"Algo salió mal!"}})),t.json({ok:!0,msg:"El código se ha enviado a tu correo electrónico, solo tendrá una validez de 5 minutos!"})}catch(s){h.default(s,e,t)}})),this.getUserById=(e,t)=>i(this,void 0,void 0,(function*(){try{yield this.db.Connect();const s=e.params.uid,i=yield o.default.findById(s).select(["img","name","lastname","google","facebook","email","username","profesional_info"]).catch((e=>{throw{status:400,msg:"Algo salió mal!",e}}));if(!i)throw{status:404,msg:"No existe información de los usuarios"};i.name=`${i.name} ${i.lastname}`;const n=m.isLocalAccount(i),a=Object.assign(Object.assign({},i._doc),{account:n});return delete a.google,delete a.facebook,yield this.db.Disconnect(),t.json({ok:!0,user:a})}catch(s){yield this.db.Disconnect(),h.default(s,e,t)}})),this.startGetUsersById=(e,t)=>i(this,void 0,void 0,(function*(){try{yield this.db.Connect();const{students:s}=e.body,i=yield o.default.find({_id:{$in:s}}).select(["name","lastname","img","facebook","google"]).catch((e=>{throw{status:400,msg:"Algo salió mal!",e}}));return yield this.db.Disconnect(),t.json({ok:!0,users:i})}catch(s){yield this.db.Disconnect(),h.default(s,e,t)}})),this.getStudentsByCollectionId=(e,t)=>i(this,void 0,void 0,(function*(){try{const s=e.body.students;yield this.db.Connect();const i=yield o.default.find({_id:{$in:s}}).select(["name","lastname","google","facebook","username","img","roles"]).catch((e=>{throw{status:400,msg:"Algo salió mal!",e}}));return t.json({ok:!0,users:i})}catch(s){yield this.db.Disconnect(),h.default(s,e,t)}}))}static init(){return p.default.warn("Iniciando nueva instancia del servicio de usuarios"),new _}}t.default=_},2167:e=>{e.exports=require("axios")},8432:e=>{e.exports=require("bcryptjs")},3582:e=>{e.exports=require("cors")},6860:e=>{e.exports=require("express")},6674:e=>{e.exports=require("express-fileupload")},3553:e=>{e.exports=require("express-validator")},6781:e=>{e.exports=require("google-auth-library")},7806:e=>{e.exports=require("helmet")},9344:e=>{e.exports=require("jsonwebtoken")},2245:e=>{e.exports=require("moment")},1185:e=>{e.exports=require("mongoose")},8037:e=>{e.exports=require("mongoose-paginate-v2")},9470:e=>{e.exports=require("morgan")},5184:e=>{e.exports=require("nodemailer")},8149:e=>{e.exports=require("nodemailer-smtp-transport")},298:e=>{e.exports=require("rate-limiter-flexible")},7558:e=>{e.exports=require("redis")},7773:e=>{e.exports=require("winston")},7147:e=>{e.exports=require("fs")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1017:e=>{e.exports=require("path")}},t={};!function s(i){var n=t[i];if(void 0!==n)return n.exports;var o=t[i]={exports:{}};return e[i].call(o.exports,o,o.exports,s),o.exports}(3607)})();